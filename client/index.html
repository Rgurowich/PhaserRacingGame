<div id="logInDiv">
  Username: <input id="logInDiv-username" type="text"></input><br> Password: <input id="logInDiv-password" type="password"></input>
  <button id="logInDiv-logIn">Log In</button>
  <button id="logInDiv-signUp">Sign Up</button>
</div>
<div id="gameDiv" style="display:none;">
  <canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>

  <div id="ingame-text" style="width:500px;height:100px;overflow-y:scroll">
    <div>Welcome!</div>
  </div>

  <form id="ingame-text-form">
    <input id="ingame-text-input" type="text" style="width:500px"></input>
  </form>
</div>

<head>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>
</body>
</body>
<script>
 var WIDTH = 500;
 var HEIGHT = 500;
  var socket = io();

  // LOGIN SCRIPT //
  var logInDiv = document.getElementById('logInDiv');
  var logInDivLogIn = document.getElementById('logInDiv-logIn');
  var logInDivSignUp = document.getElementById('logInDiv-signUp');
  var logInDivUsername = document.getElementById('logInDiv-username');
  var logInDivPassword = document.getElementById('logInDiv-password');

  logInDivLogIn.onclick = function() {
    socket.emit('logIn', {
      username: logInDivUsername.value,
      password: logInDivPassword.value
    });
  }
  logInDivSignUp.onclick = function() {
    socket.emit('signUp', {
      username: logInDivUsername.value,
      password: logInDivPassword.value
    });
  }
  socket.on('logInResponse', function(data) {
    if (data.success) {
      logInDiv.style.display = 'none';
      gameDiv.style.display = 'inline-block';
    } else
      alert("Log in unsuccessul.");
  });
  socket.on('signUpResponse', function(data) {
    if (data.success) {
      alert("Sign up successul.");
    } else
      alert("Sign up unsuccessul.");
  });

  // CHAT SCRIPT //
  var ingameText = document.getElementById('ingame-text');
  var ingameTextInput = document.getElementById('ingame-text-input');
  var ingameTextForm = document.getElementById('ingame-text-form');

  socket.on('addIngameText', function(data) {
    ingameText.innerHTML += '<div>' + data + '<div>';
  });
  socket.on('evalAnswer', function(data) {
    console.log(data);
  });

  ingameTextForm.onsubmit = function(e) {
    e.preventDefault();
    if (ingameTextInput.value[0] === '/') {
      socket.emit('evalServer', ingameTextInput.value.slice(1));
    } else {
      socket.emit('sendTxtToServer', ingameTextInput.value);
    }
    ingameTextInput.value = '';
  }

  // GAME SCRIPT //
  var Img = {};
  Img.player = new Image();
  Img.player.src = '/client/img/tank.png';
  Img.shell = new Image();
  Img.shell.src = '/client/img/bullet.png';
  Img.map = new Image();
  Img.map.src = '/client/img/map.png';
  var ctx = document.getElementById("ctx").getContext("2d");
  ctx.font = '30px Arial';

  var Player = function(initPack) {
    var self = {};
    self.id = initPack.id;
    self.number = initPack.number;
    self.x = initPack.x;
    self.y = initPack.y;
    self.hp = initPack.hp;
    self.maxHp = initPack.maxHp;
    self.score = initPack.score;
    self.draw = function() {
      var x = self.x - Player.list[selfId].x + WIDTH/2;
      var y = self.y - Player.list[selfId].y + HEIGHT/2;

      var hpWidth = 30 * self.hp / self.maxHp;
      ctx.fillStyle = 'green';
      ctx.fillRect(x - hpWidth / 2, y - 40, hpWidth, 4);
      var width = Img.player.width * 2;
      var height = Img.player.height * 2;
      ctx.drawImage(Img.player, 0, 0, Img.player.width, Img.player.height,
        x - width / 2, y - height / 2, width, height);
    }
    Player.list[self.id] = self;
    return self;
  }
  Player.list = {};

  var Shell = function(initPack) {
    var self = {};
    self.id = initPack.id;
    self.x = initPack.x;
    self.y = initPack.y;
    self.draw = function() {
      var width = Img.shell.width;
      var height = Img.shell.height;

      var x = self.x - Player.list[selfId].x + WIDTH/2;
      var y = self.y - Player.list[selfId].y + HEIGHT/2;

      ctx.drawImage(Img.shell, 0, 0, Img.shell.width, Img.shell.height,
        x - width / 2, y - height / 2, width, height);
    }
    Shell.list[self.id] = self;
    return self;
  }
  Shell.list = {};

  var selfId = null;

  socket.on('init', function(data) {
    if (data.selfId) {
      selfId = data.selfId;
    }
    for (var i = 0; i < data.player.length; i++) {
      new Player(data.player[i]);
    }
    for (var i = 0; i < data.shell.length; i++) {
      new Shell(data.shell[i]);
    }
  });

  socket.on('update', function(data) {
    for (var i = 0; i < data.player.length; i++) {
      var pack = data.player[i];
      var p = Player.list[pack.id];
      if (p) {
        if (pack.x !== undefined)
          p.x = pack.x;
        if (pack.y !== undefined)
          p.y = pack.y;
        if (pack.hp !== undefined)
          p.hp = pack.hp;
        if (pack.score !== undefined)
          p.score = pack.score;
      }
    }
    for (var i = 0; i < data.shell.length; i++) {
      var pack = data.shell[i];
      var s = Shell.list[data.shell[i].id];
      if (s) {
        if (pack.x !== undefined)
          s.x = pack.x;
        if (pack.y !== undefined)
          s.y = pack.y;
      }
    }
  });

  socket.on('remove', function(data) {
    for (var i = 0; i < data.player.length; i++) {
      delete Player.list[data.player[i]];
    }
    for (var i = 0; i < data.shell.length; i++) {
      delete Shell.list[data.shell[i]];
    }
  });

  setInterval(function() {
    if(!selfId)
      return;
    ctx.clearRect(0, 0, 500, 500);
    drawMap();
    drawScore();
    for (var i in Player.list) {
      Player.list[i].draw();
    }
    for (var i in Shell.list) {
      Shell.list[i].draw();
    }
  }, 40);

  var drawMap = function() {
    var x = WIDTH/2 - Player.list[selfId].x;
    var y = HEIGHT/2 - Player.list[selfId].y;
    ctx.drawImage(Img.map, x, y);
  }
  var drawScore = function(){
    ctx.fillRect(0,0,120,40);
    ctx.fillStyle = "white";
    ctx.fillText("Score: " + Player.list[selfId].score,0,30);
  }

  document.onkeydown = function(event) {
    if (event.keyCode === 68)
      socket.emit('keyPress', {
        inputId: 'right',
        state: true
      });
    else if (event.keyCode === 83)
      socket.emit('keyPress', {
        inputId: 'down',
        state: true
      });
    else if (event.keyCode === 65)
      socket.emit('keyPress', {
        inputId: 'left',
        state: true
      });
    else if (event.keyCode === 87)
      socket.emit('keyPress', {
        inputId: 'up',
        state: true
      });
  }

  document.onkeyup = function(event) {
    if (event.keyCode === 68)
      socket.emit('keyPress', {
        inputId: 'right',
        state: false
      });
    else if (event.keyCode === 83)
      socket.emit('keyPress', {
        inputId: 'down',
        state: false
      });
    else if (event.keyCode === 65)
      socket.emit('keyPress', {
        inputId: 'left',
        state: false
      });
    else if (event.keyCode === 87)
      socket.emit('keyPress', {
        inputId: 'up',
        state: false
      });
  }

  document.onmousedown = function(event) {
    socket.emit('keyPress', {
      inputId: 'firing',
      state: true
    });
  }
  document.onmouseup = function(event) {
    socket.emit('keyPress', {
      inputId: 'firing',
      state: false
    });
  }
  document.onmousemove = function(event) {
    var x = -250 + event.clientX - 8;
    var y = -250 + event.clientY - 8;
    var angle = Math.atan2(y, x) / Math.PI * 180;
    socket.emit('keyPress', {
      inputId: 'mouseAngle',
      state: angle
    });
  }
</script>
